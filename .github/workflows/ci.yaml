name: Terraform Multi-Cloud CI Build

on:
  workflow_call:
    inputs:
      # Cloud Provider Selection
      cloud-provider:
        description: "Target cloud provider (aws, gcp, azure, snowflake, databricks)"
        required: true
        type: string
      tflint-ver:
        description: "TFLint version to install"
        required: true
        type: string
      terraform-dir:
        description: "Directory containing Terraform configuration files relative to cloud provider path"
        required: false
        type: string
        default: "tf"

      # Backend Type Selection
      backend-type:
        description: "Backend type to use: 's3' for AWS S3 or 'remote' for HCP Terraform Cloud."
        required: false
        type: string
        default: "s3"

      # AWS Authentication Inputs
      aws-region:
        description: "AWS region for authentication. Required when cloud-provider is 'aws'."
        required: false
        type: string

      # Snowflake Authentication Inputs
      snowflake-account:
        description: "Snowflake account identifier. Required when cloud-provider is 'snowflake'."
        required: false
        type: string

      snowflake-user:
        description: "Snowflake user name. Required when cloud-provider is 'snowflake'."
        required: false
        type: string

      snowflake-role:
        description: "Snowflake role name. Required when cloud-provider is 'snowflake'."
        required: false
        type: string

      # Terraform artifacts
      tf-vars-file:
        description: "Optional Terraform variable file"
        required: false
        type: string
        default: "terraform.tfvars"
    secrets:
      # HCP Terraform Cloud Secret
      tfc-token:
        description: "HCP Terraform Cloud API token. Required when backend-type is 'remote'."
        required: false

      # AWS Authentication Secret
      aws-role-to-assume:
        description: "AWS IAM role ARN to assume. Required when cloud-provider is 'aws'."
        required: false

      # GCP Authentication Secret
      gcp-wif-provider:
        description: "GCP Workload Identity Federation provider. Required when cloud-provider is 'gcp'."
        required: false

      gcp-service-account:
        description: "GCP service account email for authentication. Required when cloud-provider is 'gcp'."
        required: false

      # Snowflake Authentication Secret
      snowflake-private-key:
        description: "Snowflake private key for authentication. Required when cloud-provider is 'snowflake'."
        required: false

      # Databricks Authentication Secrets
      databricks-host:
        description: "Databricks workspace URL. Required when cloud-provider is 'databricks'."
        required: false

      databricks-token:
        description: "Databricks personal access token. Required when cloud-provider is 'databricks'."
        required: false

      # Azure Authentication Secrets
      azure-client-id:
        description: "Azure client ID for authentication. Required when cloud-provider is 'azure'."
        required: false

      azure-tenant-id:
        description: "Azure tenant ID for authentication. Required when cloud-provider is 'azure'."
        required: false

      azure-subscription-id:
        description: "Azure subscription ID for authentication. Required when cloud-provider is 'azure'."
        required: false

permissions:
  id-token: write
  contents: read

jobs:
  terraform-lint:
    name: ‚öôÔ∏è TFLint
    runs-on: ubuntu-latest
    
    steps:
      - name: Print Inputs
        run: |
          echo "=== Workflow Inputs ==="
          echo "Cloud Provider: ${{ inputs.cloud-provider }}"
          echo "TFLint Version: ${{ inputs.tflint-ver }}"
          echo "Backend Type: ${{ inputs.backend-type }}"
          echo "Terraform Directory: ${{ inputs.terraform-dir }}"
          echo "TF Vars File: ${{ inputs.tf-vars-file }}"
          echo "TFC Token: ${{ secrets.tfc-token && '[PROVIDED]' || '[NOT PROVIDED]' }}"
          echo "AWS Region: ${{ inputs.aws-region }}"
          echo "AWS Role to Assume: ${{ secrets.aws-role-to-assume && '[PROVIDED]' || '[NOT PROVIDED]' }}"
          echo "GCP WIF Provider: ${{ secrets.gcp-wif-provider && '[PROVIDED]' || '[NOT PROVIDED]' }}"
          echo "GCP Service Account: ${{ secrets.gcp-service-account && '[PROVIDED]' || '[NOT PROVIDED]' }}"
          echo "Snowflake Account: ${{ inputs.snowflake-account }}"
          echo "Snowflake User: ${{ inputs.snowflake-user }}"
          echo "Snowflake Role: ${{ inputs.snowflake-role }}"
          echo "Snowflake Private Key: ${{ secrets.snowflake-private-key && '[PROVIDED]' || '[NOT PROVIDED]' }}"
          echo "Databricks Host: ${{ secrets.databricks-host && '[PROVIDED]' || '[NOT PROVIDED]' }}"
          echo "Databricks Token: ${{ secrets.databricks-token && '[PROVIDED]' || '[NOT PROVIDED]' }}"
          echo "Azure Client ID: ${{ secrets.azure-client-id && '[PROVIDED]' || '[NOT PROVIDED]' }}"
          echo "Azure Tenant ID: ${{ secrets.azure-tenant-id && '[PROVIDED]' || '[NOT PROVIDED]' }}"
          echo "Azure Subscription ID: ${{ secrets.azure-subscription-id && '[PROVIDED]' || '[NOT PROVIDED]' }}"
          echo "======================="

      # Validate input configuration
      #############################################
      - name: Validate Input Configuration
        run: |
          # Validate cloud provider value
          if [[ "${{ inputs.cloud-provider }}" != "aws" && "${{ inputs.cloud-provider }}" != "gcp" && "${{ inputs.cloud-provider }}" != "azure" && "${{ inputs.cloud-provider }}" != "snowflake" && "${{ inputs.cloud-provider }}" != "databricks" ]]; then
            echo "Error: Invalid cloud provider '${{ inputs.cloud-provider }}'. Must be one of: aws, gcp, azure, snowflake, databricks"
            exit 1
          fi
          echo "Valid cloud provider: ${{ inputs.cloud-provider }}"
          
          # Validate AWS requirements
          if [[ "${{ inputs.cloud-provider }}" == "aws" ]]; then
            echo "Validating AWS requirements..."
            if [[ -z "${{ inputs.aws-region }}" ]]; then
              echo "Error: aws-region is required when cloud-provider is 'aws'"
              exit 1
            fi
            if [[ -z "${{ secrets.aws-role-to-assume }}" ]]; then
              echo "Error: aws-role-to-assume secret is required when cloud-provider is 'aws'"
              exit 1
            fi
            echo "‚úì AWS requirements validated"
          fi
          
          # Validate GCP requirements
          if [[ "${{ inputs.cloud-provider }}" == "gcp" ]]; then
            echo "Validating GCP requirements..."
            if [[ -z "${{ secrets.gcp-wif-provider }}" ]]; then
              echo "Error: gcp-wif-provider secret is required when cloud-provider is 'gcp'"
              exit 1
            fi
            if [[ -z "${{ secrets.gcp-service-account }}" ]]; then
              echo "Error: gcp-service-account secret is required when cloud-provider is 'gcp'"
              exit 1
            fi
            echo "‚úì GCP requirements validated"
          fi
          
          # Validate Azure requirements
          if [[ "${{ inputs.cloud-provider }}" == "azure" ]]; then
            echo "Validating Azure requirements..."
            if [[ -z "${{ secrets.azure-client-id }}" ]]; then
              echo "Error: azure-client-id secret is required when cloud-provider is 'azure'"
              exit 1
            fi
            if [[ -z "${{ secrets.azure-tenant-id }}" ]]; then
              echo "Error: azure-tenant-id secret is required when cloud-provider is 'azure'"
              exit 1
            fi
            if [[ -z "${{ secrets.azure-subscription-id }}" ]]; then
              echo "Error: azure-subscription-id secret is required when cloud-provider is 'azure'"
              exit 1
            fi
            echo "‚úì Azure requirements validated"
          fi
          
          # Validate Snowflake requirements
          if [[ "${{ inputs.cloud-provider }}" == "snowflake" ]]; then
            echo "Validating Snowflake requirements..."
            if [[ -z "${{ inputs.snowflake-account }}" ]]; then
              echo "Error: snowflake-account is required when cloud-provider is 'snowflake'"
              exit 1
            fi
            if [[ -z "${{ inputs.snowflake-user }}" ]]; then
              echo "Error: snowflake-user is required when cloud-provider is 'snowflake'"
              exit 1
            fi
            if [[ -z "${{ inputs.snowflake-role }}" ]]; then
              echo "Error: snowflake-role is required when cloud-provider is 'snowflake'"
              exit 1
            fi
            if [[ -z "${{ secrets.snowflake-private-key }}" ]]; then
              echo "Error: snowflake-private-key secret is required when cloud-provider is 'snowflake'"
              exit 1
            fi
            echo "‚úì Snowflake requirements validated"
          fi
          
          # Validate Databricks requirements
          if [[ "${{ inputs.cloud-provider }}" == "databricks" ]]; then
            echo "Validating Databricks requirements..."
            if [[ -z "${{ secrets.databricks-host }}" ]]; then
              echo "Error: databricks-host secret is required when cloud-provider is 'databricks'"
              exit 1
            fi
            if [[ -z "${{ secrets.databricks-token }}" ]]; then
              echo "Error: databricks-token secret is required when cloud-provider is 'databricks'"
              exit 1
            fi
            echo "‚úì Databricks requirements validated"
          fi
          
          echo "All validations passed successfully!"

      - name: Run TFLint
        uses: subhamay-bhattacharyya-gha/tf-lint-action@main
        with:
          terraform-dir: infra/${{ inputs.cloud-provider }}/${{ inputs.terraform-dir }}
          tflint-ver: ${{ inputs.tflint-ver }}
          use-cache: "true"
          tflint-format: "compact"

  terraform-validate:
    name: ‚úÖ Validate
    runs-on: ubuntu-latest
    needs: 
      - terraform-lint

    steps:
      - name: Terraform Validate 
        uses: subhamay-bhattacharyya-gha/tf-validate-action@main
        with:
          terraform-dir: infra/${{ inputs.cloud-provider }}/${{ inputs.terraform-dir }}

  terraform-plan:
    name: üîç Plan
    runs-on: ubuntu-latest
    needs: 
      - terraform-validate

    steps:
      - name: Terraform Plan 
        uses: subhamay-bhattacharyya-gha/tf-plan-action@main
        with:
          cloud-provider: ${{ inputs.cloud-provider }}
          terraform-dir: infra/${{ inputs.cloud-provider }}/${{ inputs.terraform-dir }}
          backend-type: ${{ inputs.backend-type }}
          tfc-token: ${{ secrets.tfc-token }}
          aws-region: ${{ inputs.aws-region }}
          aws-role-to-assume: ${{ secrets.aws-role-to-assume }}
          gcp-wif-provider: ${{ secrets.gcp-wif-provider }}
          gcp-service-account: ${{ secrets.gcp-service-account }}
          snowflake-account: ${{ inputs.snowflake-account }}
          snowflake-user: ${{ inputs.snowflake-user }}
          snowflake-role: ${{ inputs.snowflake-role }}
          snowflake-private-key: ${{ secrets.snowflake-private-key }}
          databricks-host: ${{ secrets.databricks-host }}
          databricks-token: ${{ secrets.databricks-token }}
          azure-client-id: ${{ secrets.azure-client-id }}
          azure-tenant-id: ${{ secrets.azure-tenant-id }}
          azure-subscription-id: ${{ secrets.azure-subscription-id }}
          tf-vars-file: ${{ inputs.tf-vars-file }}
          tf-plan-name: ${{ inputs.cloud-provider }}-terraform-plan
